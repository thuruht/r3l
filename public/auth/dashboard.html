<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>R3L:F OAuth Dashboard</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f9f9f9;
        }
        
        header {
            background-color: #333;
            color: #fff;
            padding: 20px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        
        h1, h2, h3 {
            margin-top: 0;
        }
        
        .card {
            background-color: #fff;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .provider-card {
            border-left: 5px solid #4CAF50;
            margin-bottom: 20px;
        }
        
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 5px;
        }
        
        .status-unknown {
            background-color: #9e9e9e;
        }
        
        .status-ok {
            background-color: #4CAF50;
            color: #4CAF50;
        }
        
        .status-warning {
            background-color: #FF9800;
            color: #FF9800;
        }
        
        .status-error {
            background-color: #F44336;
            color: #F44336;
        }
        
        .flex-container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
        }
        
        .flex-item {
            flex: 1;
            min-width: 300px;
        }
        
        button {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 10px 15px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 14px;
            margin: 4px 2px;
            cursor: pointer;
            border-radius: 4px;
        }
        
        button:hover {
            background-color: #45a049;
        }
        
        code {
            font-family: monospace;
            background-color: #f5f5f5;
            padding: 2px 5px;
            border-radius: 3px;
            font-size: 0.9em;
        }
        
        pre {
            background-color: #f5f5f5;
            padding: 10px;
            border-radius: 5px;
            overflow-x: auto;
        }
        
        .accordion {
            background-color: #eee;
            color: #444;
            cursor: pointer;
            padding: 18px;
            width: 100%;
            text-align: left;
            border: none;
            outline: none;
            transition: 0.4s;
            border-radius: 4px;
        }
        
        .active, .accordion:hover {
            background-color: #ccc;
        }
        
        .panel {
            padding: 0 18px;
            background-color: white;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.2s ease-out;
        }
    </style>
</head>
<body>
    <header>
        <h1>R3L:F OAuth Dashboard</h1>
        <p>Monitor and manage OAuth providers and configurations</p>
    </header>
    
    <div class="card">
        <h2>System Status</h2>
        <div class="flex-container">
            <div class="flex-item">
                <h3>Main Worker</h3>
                <p><span class="status-indicator status-unknown" id="main-worker-status"></span> <span id="main-worker-status-text">Checking...</span></p>
                <p>Service bindings: <span id="service-bindings">Checking...</span></p>
            </div>
            <div class="flex-item">
                <h3>OAuth Provider Worker</h3>
                <p><span class="status-indicator status-unknown" id="oauth-worker-status"></span> <span id="oauth-worker-status-text">Checking...</span></p>
                <p>Version: <span id="oauth-worker-version">Checking...</span></p>
            </div>
        </div>
    </div>
    
    <div class="flex-container">
        <div class="flex-item">
            <div class="card provider-card">
                <h3>GitHub OAuth</h3>
                <p><span class="status-indicator status-unknown" id="github-status"></span> <span id="github-status-text">Checking...</span></p>
                <p>Client ID: <span id="github-client-id">••••••••</span></p>
                <p>Callback URL: <span id="github-callback-url"></span></p>
                <button onclick="testOAuth('github')">Test Login</button>
            </div>
        </div>
        
        <div class="flex-item">
            <div class="card provider-card">
                <h3>ORCID OAuth</h3>
                <p><span class="status-indicator status-unknown" id="orcid-status"></span> <span id="orcid-status-text">Checking...</span></p>
                <p>Client ID: <span id="orcid-client-id">••••••••</span></p>
                <p>Callback URL: <span id="orcid-callback-url"></span></p>
                <button onclick="testOAuth('orcid')">Test Login</button>
            </div>
        </div>
    </div>
    
    <div class="card">
        <h2>Debug Tools</h2>
        
        <div class="card">
            <h3>Cookie Status</h3>
            <p>Session Cookie: <span id="session-cookie-status">Checking...</span></p>
            <p>Auth State Cookie: <span id="auth-state-cookie-status">Checking...</span></p>
            <button onclick="checkCookies()">Check Cookies</button>
            <button onclick="fixCookies()">Fix Cookies</button>
            <button onclick="clearCookies()">Clear Cookies</button>
        </div>
        
        <button class="accordion">OAuth Flow Diagram</button>
        <div class="panel">
            <pre>
+----------------+      +------------------+      +------------------+
| User's Browser |----->| Main R3L Worker  |----->| OAuth Provider   |
+----------------+      +------------------+      +------------------+
        |                        |                        |
        |                        |                        |
        |                        |       Redirects to     |
        |<-----------------------------------------------------+
        |                        |    GitHub/ORCID Auth    |
        |                        |                        |
        |   OAuth Provider       |                        |
        +------------------------------------------------------+
        |                        |                        |
        |   Callback with code   |                        |
        +---------------------+  |                        |
                              |  |                        |
                              v  v                        |
                     +------------------+                 |
                     | OAuth Provider   |<----------------+
                     +------------------+
                              |
                              | Create session/tokens
                              v
                     +------------------+
                     | Main R3L Worker  |
                     +------------------+
                              |
                              | Set cookies, redirect
                              v
                     +----------------+
                     | User's Browser |
                     +----------------+
            </pre>
        </div>
        
        <button class="accordion">Example OAuth Request/Response</button>
        <div class="panel">
            <h4>OAuth Authorization Request</h4>
            <pre>
GET /auth/github/login HTTP/1.1
Host: r3l-project.example.workers.dev
User-Agent: Mozilla/5.0 ...
Accept: text/html,application/xhtml+xml...
            </pre>
            
            <h4>OAuth Callback Request</h4>
            <pre>
GET /auth/github/callback?code=abc123&state=xyz789 HTTP/1.1
Host: r3l-project.example.workers.dev
User-Agent: Mozilla/5.0 ...
Accept: text/html,application/xhtml+xml...
            </pre>
        </div>
        
        <button class="accordion">Common Issues & Solutions</button>
        <div class="panel">
            <h4>Invalid Callback URL</h4>
            <p>Make sure the callback URL in your OAuth application settings exactly matches what's configured in your Worker.</p>
            <p>For GitHub: <code>https://[your-domain]/auth/github/callback</code></p>
            <p>For ORCID: <code>https://[your-domain]/auth/orcid/callback</code></p>
            
            <h4>Missing Secrets</h4>
            <p>Ensure all required secrets are set with <code>wrangler secret put</code>:</p>
            <ul>
                <li>GITHUB_CLIENT_ID</li>
                <li>GITHUB_CLIENT_SECRET</li>
                <li>ORCID_CLIENT_ID</li>
                <li>ORCID_CLIENT_SECRET</li>
            </ul>
            
            <h4>Service Binding Issues</h4>
            <p>Check that the service binding is correctly set up in wrangler.jsonc:</p>
            <pre>
  "services": [
    {
      "binding": "OAUTH_PROVIDER",
      "service": "workers-oauth-provider"
    }
  ]</pre>
            <p>And make sure both Workers are deployed before testing.</p>
        </div>
    </div>
    
    <script>
        // Initialize accordions
        const accordions = document.getElementsByClassName("accordion");
        for (let i = 0; i < accordions.length; i++) {
            accordions[i].addEventListener("click", function() {
                this.classList.toggle("active");
                const panel = this.nextElementSibling;
                if (panel.style.maxHeight) {
                    panel.style.maxHeight = null;
                } else {
                    panel.style.maxHeight = panel.scrollHeight + "px";
                }
            });
        }
        
        // Populate fields based on current domain
        document.addEventListener('DOMContentLoaded', function() {
            const domain = window.location.hostname;
            document.getElementById('github-callback-url').textContent = `https://${domain}/auth/github/callback`;
            document.getElementById('orcid-callback-url').textContent = `https://${domain}/auth/orcid/callback`;
            
            // Simulate checking statuses (this would be real API calls in production)
            setTimeout(() => {
                document.getElementById('main-worker-status').className = 'status-indicator status-ok';
                document.getElementById('main-worker-status-text').textContent = 'Running';
                document.getElementById('service-bindings').textContent = 'OAUTH_PROVIDER: workers-oauth-provider';
                
                document.getElementById('oauth-worker-status').className = 'status-indicator status-ok';
                document.getElementById('oauth-worker-status-text').textContent = 'Running';
                document.getElementById('oauth-worker-version').textContent = '1.0.0';
                
                document.getElementById('github-status').className = 'status-indicator status-ok';
                document.getElementById('github-status-text').textContent = 'Configured';
                
                document.getElementById('orcid-status').className = 'status-indicator status-ok';
                document.getElementById('orcid-status-text').textContent = 'Configured';
            }, 1500);
        });
        
        function testOAuth(provider) {
            window.location.href = `/api/auth/${provider}/init`;
        }
        
        function checkCookies() {
            const cookies = document.cookie.split(';').reduce((acc, cookie) => {
                const [key, value] = cookie.trim().split('=');
                acc[key] = value;
                return acc;
            }, {});
            
            const sessionCookie = cookies.r3l_session;
            const authStateCookie = cookies.r3l_auth_state;
            
            document.getElementById('session-cookie-status').innerHTML = 
                sessionCookie ? `<span class="status-ok">Present</span> (${sessionCookie.substring(0, 8)}...)` : 
                '<span class="status-error">Missing</span>';
            
            document.getElementById('auth-state-cookie-status').innerHTML = 
                authStateCookie ? `<span class="status-ok">Present</span> (${authStateCookie})` : 
                '<span class="status-error">Missing</span>';
                
            // Also validate with API
            fetch('/api/auth/validate', {
                credentials: 'include'
            })
            .then(response => response.json())
            .then(data => {
                console.log('Auth validation response:', data);
                if (data.valid) {
                    alert('Authentication is valid! User: ' + JSON.stringify(data.user));
                } else {
                    alert('Authentication is invalid: ' + (data.error || 'Unknown error'));
                }
            })
            .catch(error => {
                console.error('Error validating auth:', error);
                alert('Error validating authentication: ' + error.message);
            });
        }
        
        function fixCookies() {
            fetch('/api/auth/fix-cookies', {
                credentials: 'include'
            })
            .then(response => response.json())
            .then(data => {
                console.log('Fix cookies response:', data);
                alert('Cookies fixed: ' + JSON.stringify(data));
                checkCookies();
            })
            .catch(error => {
                console.error('Error fixing cookies:', error);
                alert('Error fixing cookies: ' + error.message);
            });
        }
        
        function clearCookies() {
            // First call logout API to clear server-side session
            fetch('/api/auth/logout', {
                method: 'POST',
                credentials: 'include'
            })
            .then(() => {
                // Also clear cookies client-side
                document.cookie = 'r3l_session=; Path=/; Expires=Thu, 01 Jan 1970 00:00:01 GMT;';
                document.cookie = 'r3l_auth_state=; Path=/; Expires=Thu, 01 Jan 1970 00:00:01 GMT;';
                alert('Cookies cleared');
                checkCookies();
            })
            .catch(error => {
                console.error('Error clearing cookies:', error);
                alert('Error clearing cookies: ' + error.message);
            });
        }
    </script>
</body>
</html>
