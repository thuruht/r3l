<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GitHub Authentication - R3L:F</title>
  <link rel="stylesheet" href="/css/rel-f-global.css">
  <link rel="stylesheet" href="/css/callback-pages.css">
  <script src="/js/font-loader.js" defer></script>
  <script type="module">
    import { NavigationBar } from '/js/components/navigation.js';
    document.addEventListener('DOMContentLoaded', () => {
      NavigationBar.init('login');
      handleAuthCallback();
    });

    async function handleAuthCallback() {
      const statusEl = document.getElementById('auth-status');
      const messageEl = document.getElementById('auth-message');
      const spinnerEl = document.getElementById('auth-spinner');
      const redirectInfo = document.getElementById('redirect-info');
      
      try {
        // Get code and state from URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const code = urlParams.get('code');
        const state = urlParams.get('state');
        
        if (!code) {
          throw new Error('No authorization code found in the URL');
        }
        
        // Show processing message
        statusEl.textContent = 'Processing...';
        messageEl.textContent = 'Completing GitHub authentication';
        
        // Determine the callback endpoint
        const callbackEndpoint = `/api/auth/github/callback?code=${encodeURIComponent(code)}`;
        
        // Add state parameter if present
        const fullEndpoint = state ? 
          `${callbackEndpoint}&state=${encodeURIComponent(state)}` : 
          callbackEndpoint;
        
        // Call the backend API to complete authentication
        console.log('Calling backend API:', fullEndpoint);
        const response = await fetch(fullEndpoint, {
          headers: {
            'Accept': 'application/json'
          }
        });
        
        console.log('Response status:', response.status, response.statusText);
        
        // Get the response text first
        const responseText = await response.text();
        console.log('Response text:', responseText);
        
        // Try to parse it as JSON
        try {
          // Only try to parse if we have text content
          const data = responseText ? JSON.parse(responseText) : {};
          console.log('Parsed data:', data);
          
          // Check for error responses
          if (!response.ok || (data && data.success === false)) {
            const errorMessage = data && data.message ? data.message : 'Authentication failed';
            throw new Error(errorMessage);
          }
          
          // Hide spinner, show success
          spinnerEl.classList.add('hidden');
          statusEl.textContent = 'Success!';
          statusEl.className = 'text-success';
          messageEl.textContent = 'Authentication complete. Redirecting to your profile...';
          
          // Check the cookie
          console.log('Cookies after auth:', document.cookie);
          
          // Show countdown
          let seconds = 3;
          redirectInfo.textContent = `Redirecting in ${seconds} seconds...`;
          redirectInfo.classList.remove('hidden');
          
          const interval = setInterval(() => {
            seconds--;
            redirectInfo.textContent = `Redirecting in ${seconds} seconds...`;
            
            if (seconds <= 0) {
              clearInterval(interval);
              // Redirect to profile or provided redirect URL
              window.location.href = data.redirectUrl || '/profile.html';
            }
          }, 1000);
        } catch (parseError) {
          console.error('Response parsing error:', parseError, 'Raw response:', responseText);
          throw new Error(parseError.message || 'Could not parse server response');
        }
      } catch (error) {
        console.error('Authentication error:', error);
        
        // Hide spinner, show error
        spinnerEl.classList.add('hidden');
        statusEl.textContent = 'Error';
        statusEl.className = 'text-error';
        
        // Check for specific database error and display more helpful message
        if (error.message && error.message.includes('no such table: users')) {
          messageEl.innerHTML = `
            <div class="error-details">
              <p><strong>Database Error:</strong> The database tables are not initialized.</p>
              
              <div class="info-box">
                <p><strong>For System Administrators:</strong></p>
                <p>The database needs to be initialized with the required tables. Please run:</p>
                <pre class="code-block">cd migrations
chmod +x apply-migrations.sh
./apply-migrations.sh --remote [DATABASE_NAME]</pre>
              </div>
              
              <p>This is a one-time setup process to create the necessary database schema.</p>
              <p>For more information, see the <a href="/docs/database-setup.md" target="_blank">Database Setup Guide</a>.</p>
            </div>
          `;
        } else if (error.message && error.message.includes('no column named updated_at')) {
          messageEl.innerHTML = `
            <div class="error-details">
              <p><strong>Database Schema Error:</strong> The users table is missing the updated_at column.</p>
              
              <div class="info-box">
                <p><strong>For System Administrators:</strong></p>
                <p>Please run the following command to add the missing column:</p>
                <pre class="code-block">cd migrations
chmod +x update-content-schema.sh
./update-content-schema.sh</pre>
              </div>
              
              <p>This will update the database schema to include all required columns.</p>
              <p>For more information, see the <a href="/docs/database-setup.md" target="_blank">Database Setup Guide</a>.</p>
            </div>
          `;
        } else if (error.message && error.message.includes('no column named token')) {
          messageEl.innerHTML = `
            <div class="error-details">
              <p><strong>Database Schema Error:</strong> The auth_sessions table is missing the token column.</p>
              
              <div class="info-box">
                <p><strong>For System Administrators:</strong></p>
                <p>Please run the following command to add the missing column:</p>
                <pre class="code-block">cd migrations
chmod +x update-content-schema.sh
./update-content-schema.sh</pre>
              </div>
              
              <p>This will update the database schema to include all required columns.</p>
              <p>For more information, see the <a href="/docs/database-setup.md" target="_blank">Database Setup Guide</a>.</p>
            </div>
          `;
        } else {
          messageEl.innerHTML = `
            <p>${error.message || 'Authentication failed. Please try again.'}</p>
            <p>If this error persists, please contact the system administrator.</p>
          `;
        }
        
        // Show retry link
        document.getElementById('retry-link').classList.remove('hidden');
      }
    }
  </script>
  <style>
    .auth-container {
      max-width: 500px;
      margin: 2rem auto;
      padding: 2rem;
      background-color: var(--bg-container);
      border-radius: 8px;
      box-shadow: var(--shadow-medium);
    }
    
    .auth-title {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 1.5rem;
    }
    
    .auth-spinner {
      display: flex;
      justify-content: center;
      margin: 2rem 0;
    }
    
    .spinner {
      width: 48px;
      height: 48px;
      border: 5px solid var(--accent-lavender);
      border-bottom-color: transparent;
      border-radius: 50%;
      animation: spin 1.5s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .text-success {
      color: var(--success);
    }
    
    .text-error {
      color: var(--error);
    }
    
    .hidden {
      display: none;
    }
  </style>
</head>
<body>
  <header>
    <div class="container">
      <!-- Navigation will be inserted by JavaScript -->
    </div>
  </header>

  <main class="container">
    <div class="auth-container">
      <div class="auth-title">
        <span class="material-icons" aria-hidden="true">lock</span>
        <h1>GitHub Authentication</h1>
      </div>
      
      <div class="auth-status">
        <h2 id="auth-status">Authenticating...</h2>
        <p id="auth-message">Completing authentication with GitHub</p>
      </div>
      
      <div id="auth-spinner" class="auth-spinner">
        <div class="spinner"></div>
      </div>
      
      <p id="redirect-info" class="text-center hidden"></p>
      
      <div id="retry-link" class="text-center mt-4 hidden">
        <a href="/login.html" class="btn">
          <span class="material-icons">refresh</span>
          Try Again
        </a>
      </div>
    </div>
  </main>

  <footer class="footer">
    <p class="footer-motto">"the rel is what you make it"</p>
    <p>&copy; 2025 R3L:F Project - Built with Cloudflare</p>
  </footer>
</body>
</html>
