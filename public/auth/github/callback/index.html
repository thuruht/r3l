<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GitHub Authentication - R3L:F</title>
  <link rel="stylesheet" href="/css/rel-f-global.css">
  <script src="/js/font-loader.js" defer></script>
  <script type="module">
    import { NavigationBar } from '/js/components/navigation.js';
    document.addEventListener('DOMContentLoaded', () => {
      NavigationBar.init('login');
      handleAuthCallback();
    });

    async function handleAuthCallback() {
      const statusEl = document.getElementById('auth-status');
      const messageEl = document.getElementById('auth-message');
      const spinnerEl = document.getElementById('auth-spinner');
      const redirectInfo = document.getElementById('redirect-info');
      
      try {
        // Get code and state from URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const code = urlParams.get('code');
        const state = urlParams.get('state');
        
        if (!code) {
          throw new Error('No authorization code found in the URL');
        }
        
        // Show processing message
        statusEl.textContent = 'Processing...';
        messageEl.textContent = 'Completing GitHub authentication';
        
        // Determine the callback endpoint
        const callbackEndpoint = `/api/auth/github/callback?code=${encodeURIComponent(code)}`;
        
        // Add state parameter if present
        const fullEndpoint = state ? 
          `${callbackEndpoint}&state=${encodeURIComponent(state)}` : 
          callbackEndpoint;
        
        // Call the backend API to complete authentication
        const response = await fetch(fullEndpoint);
        
        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.message || 'Authentication failed');
        }
        
        const data = await response.json();
        
        // Hide spinner, show success
        spinnerEl.classList.add('hidden');
        statusEl.textContent = 'Success!';
        statusEl.className = 'text-success';
        messageEl.textContent = 'Authentication complete. Redirecting to your profile...';
        
        // Show countdown
        let seconds = 3;
        redirectInfo.textContent = `Redirecting in ${seconds} seconds...`;
        redirectInfo.classList.remove('hidden');
        
        const interval = setInterval(() => {
          seconds--;
          redirectInfo.textContent = `Redirecting in ${seconds} seconds...`;
          
          if (seconds <= 0) {
            clearInterval(interval);
            // Redirect to profile or provided redirect URL
            window.location.href = data.redirectUrl || '/profile.html';
          }
        }, 1000);
      } catch (error) {
        console.error('Authentication error:', error);
        
        // Hide spinner, show error
        spinnerEl.classList.add('hidden');
        statusEl.textContent = 'Error';
        statusEl.className = 'text-error';
        messageEl.textContent = error.message || 'Authentication failed. Please try again.';
        
        // Show retry link
        document.getElementById('retry-link').classList.remove('hidden');
      }
    }
  </script>
  <style>
    .auth-container {
      max-width: 500px;
      margin: 2rem auto;
      padding: 2rem;
      background-color: var(--bg-container);
      border-radius: 8px;
      box-shadow: var(--shadow-medium);
    }
    
    .auth-title {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 1.5rem;
    }
    
    .auth-spinner {
      display: flex;
      justify-content: center;
      margin: 2rem 0;
    }
    
    .spinner {
      width: 48px;
      height: 48px;
      border: 5px solid var(--accent-lavender);
      border-bottom-color: transparent;
      border-radius: 50%;
      animation: spin 1.5s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .text-success {
      color: var(--success);
    }
    
    .text-error {
      color: var(--error);
    }
    
    .hidden {
      display: none;
    }
  </style>
</head>
<body>
  <header>
    <div class="container">
      <!-- Navigation will be inserted by JavaScript -->
    </div>
  </header>

  <main class="container">
    <div class="auth-container">
      <div class="auth-title">
        <span class="material-icons" aria-hidden="true">lock</span>
        <h1>GitHub Authentication</h1>
      </div>
      
      <div class="auth-status">
        <h2 id="auth-status">Authenticating...</h2>
        <p id="auth-message">Completing authentication with GitHub</p>
      </div>
      
      <div id="auth-spinner" class="auth-spinner">
        <div class="spinner"></div>
      </div>
      
      <p id="redirect-info" class="text-center hidden"></p>
      
      <div id="retry-link" class="text-center mt-4 hidden">
        <a href="/login.html" class="btn">
          <span class="material-icons">refresh</span>
          Try Again
        </a>
      </div>
    </div>
  </main>

  <footer class="footer">
    <p class="footer-motto">"the rel is what you make it"</p>
    <p>&copy; 2025 R3L:F Project - Built with Cloudflare</p>
  </footer>
</body>
</html>
