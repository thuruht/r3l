<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>R3L:F ‚Äî Content</title>
  <link rel="stylesheet" href="./css/rel-f-global.css" />
  <link rel="stylesheet" href="./css/rel-f-accent.css" />

  <!-- Load critical auth helper script synchronously -->
  <script src="/js/utils/secure-api-helper.js"></script>
  <script src="/js/utils/debug-logger.js" defer></script>
</head>
<body>
  <header class="container"></header>
  <main class="container">
    <div id="content-root" class="card card-accent" style="margin-top:1rem;"></div>
    <div id="comments-section" class="card" style="margin-top:1rem;">
      <div class="card-header">
        <h3>Comments</h3>
      </div>
      <div class="card-body">
        <!-- Comments will be rendered here -->
      </div>
    </div>
  </main>
  <footer class="footer">
    <p class="footer-motto text-accent">"the rel is what you make it"</p>
    <div class="footer-links">
      <a href="index.html">Home</a> | 
      <a href="help.html">Help</a> | 
      <a href="about.html">About</a> | 
      <a href="sitemap.html">Site Map</a>
    </div>
  </footer>
  <script type="module" src="./js/comments.js"></script>
  <script type="module">
    import { NavigationBar } from './js/components/navigation.js';

    NavigationBar.init('content');

    const params = new URLSearchParams(window.location.search);
    const id = params.get('id');
    const root = document.getElementById('content-root');

    function escapeHtml(str){
      return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/\"/g,'&quot;').replace(/'/g,'&#39;');
    }

    async function load(){
      if(!id){
        root.innerHTML = '<p class="text-muted">No content id provided.</p>';
        return;
      }

      const data = await window.r3l.apiGet(window.r3l.API_ENDPOINTS.CONTENT.GET(id));

      if(data && !data.error){
        root.innerHTML = `
          <div class="card-header" style="display:flex;align-items:center;gap:.75rem;">
            <img src="/icons/avatar.svg" alt="avatar" width="40" height="40" style="border-radius:50%"/>
            <div>
              <div class="text-accent">${escapeHtml(data.display_name || data.username || '')}</div>
              <div class="text-muted" style="font-size:.85em;">${new Date(data.created_at).toLocaleString()}</div>
            </div>
          </div>
          <div class="card-body">
            <h2>${escapeHtml(data.title || '(untitled)')}</h2>
            ${data.description ? `<p>${escapeHtml(data.description)}</p>` : ''}
            <div id="actions-container" style="margin-top:1rem; display: flex; gap: 0.5rem;">
              <a class="btn" href="/api/content/${id}/download" target="_blank">Download</a>
              <button id="vote-btn" class="btn btn-secondary">Vote to Archive</button>
              <button id="bookmark-btn" class="btn btn-secondary">Bookmark</button>
            </div>
            <div id="vote-status" class="text-muted" style="margin-top:0.5rem;"></div>
            <div id="reactions-section" style="margin-top:1rem;">
              <button class="btn btn-sm" data-reaction="like">üëç</button>
              <button class="btn btn-sm" data-reaction="love">‚ù§Ô∏è</button>
              <button class="btn btn-sm" data-reaction="insightful">üí°</button>
            </div>
          </div>`;

        // Attach event listeners only if the user is authenticated
        if (window.r3l.isAuthenticated()) {
            document.getElementById('vote-btn').addEventListener('click', vote);
            document.getElementById('bookmark-btn').addEventListener('click', toggleBookmark);
            document.getElementById('reactions-section').addEventListener('click', handleReaction);
        } else {
            // Disable buttons if user is not logged in
            document.getElementById('vote-btn').disabled = true;
            document.getElementById('bookmark-btn').disabled = true;
            document.querySelectorAll('#reactions-section button').forEach(b => b.disabled = true);
            document.getElementById('vote-status').textContent = 'You must be logged in to interact.';
        }

        window.comments = window.Comments.init(id);
      } else {
        root.innerHTML = `<p class="text-error">Failed to load content. ${data.error || ''}</p>`;
      }
    }

    async function vote() {
      const voteBtn = document.getElementById('vote-btn');
      const voteStatus = document.getElementById('vote-status');
      voteBtn.disabled = true;
      voteStatus.textContent = 'Submitting vote...';

      try {
        const result = await window.r3l.apiPost(window.r3l.API_ENDPOINTS.CONTENT.VOTE(id));
        voteStatus.textContent = `Vote successful!`;
        voteBtn.textContent = 'Voted!';
      } catch (error) {
        voteStatus.textContent = `Error: ${error.message || 'Failed to vote.'}`;
        voteBtn.disabled = false;
      }
    }

    async function toggleBookmark() {
        const bookmarkBtn = document.getElementById('bookmark-btn');
        const isBookmarked = bookmarkBtn.classList.contains('btn-primary');

        try {
            if (isBookmarked) {
                await window.r3l.apiDelete(window.r3l.API_ENDPOINTS.CONTENT.BOOKMARK(id));
                bookmarkBtn.textContent = 'Bookmark';
                bookmarkBtn.classList.remove('btn-primary');
                bookmarkBtn.classList.add('btn-secondary');
            } else {
                await window.r3l.apiPost(window.r3l.API_ENDPOINTS.CONTENT.BOOKMARK(id));
                bookmarkBtn.textContent = 'Bookmarked';
                bookmarkBtn.classList.remove('btn-secondary');
                bookmarkBtn.classList.add('btn-primary');
            }
        } catch (error) {
            console.error('Bookmark error:', error);
            alert('Failed to update bookmark.');
        }
    }

    async function handleReaction(e) {
        if (e.target.matches('button[data-reaction]')) {
            const reaction = e.target.dataset.reaction;
            try {
                await window.r3l.apiPost(window.r3l.API_ENDPOINTS.CONTENT.REACT(id), { reaction });
                e.target.classList.add('btn-primary');
                e.target.disabled = true;
            } catch (error) {
                console.error('Reaction error:', error);
                alert('Failed to save reaction.');
            }
        }
    }

    load();
  </script>
</body>
</html>