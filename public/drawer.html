<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Your Drawer - R3L:F</title>
  <link rel="stylesheet" href="./css/rel-f-global.css">
  <script src="./js/font-loader.js" defer></script>
  <script type="module">
    import { NavigationBar } from './js/components/navigation.js';
    document.addEventListener('DOMContentLoaded', () => {
      NavigationBar.init('drawer');
    });
  </script>
  <style>
    /* Compact header styles */
    .drawer-title {
      display: flex;
      align-items: center;
      margin-bottom: 1rem;
      gap: 0.5rem;
    }
    .drawer-title h1 {
      margin: 0;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .drawer-title p {
      margin: 0;
      font-size: var(--fs-lg);
      color: var(--text-secondary);
    }
    
    /* Communique editor styles */
    #communique-editor-container {
      margin-bottom: 1.5rem;
    }
    
    .communique {
      min-height: 200px;
      padding: 1rem;
      border: 1px solid var(--border-color);
      border-radius: var(--radius-sm);
      background-color: var(--bg-surface);
      margin-bottom: 0.5rem;
      overflow-y: auto;
      line-height: 1.5;
    }
    
    .communique:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 2px rgba(109, 40, 217, 0.2);
    }
    
    .communique[contenteditable="true"]:empty:before {
      content: attr(data-placeholder);
      color: var(--text-muted);
      font-style: italic;
    }
    
    /* Hide elements when toggling */
    .hidden {
      display: none !important;
    }
    
    #communique-toolbar {
      padding: 0.5rem;
      background-color: var(--bg-surface-hover);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-sm);
      margin-bottom: 0.5rem;
    }
    
    .btn-small {
      padding: 0.25rem 0.5rem;
      font-size: var(--fs-sm);
    }
    
    .text-muted {
      color: var(--text-muted);
    }
    
    .text-sm {
      font-size: var(--fs-sm);
    }
    
    /* File embed styles */
    .file-embed {
      display: inline-flex;
      align-items: center;
      padding: 0.5rem;
      border: 1px solid var(--border-color);
      border-radius: var(--radius-sm);
      background-color: var(--bg-surface-hover);
      text-decoration: none;
      color: var(--text-primary);
      margin: 0.5rem 0;
    }
    
    .file-embed .material-icons {
      margin-right: 0.5rem;
    }
    
    /* Modal styles for file embedding */
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    
    .modal-content {
      background-color: var(--bg-surface);
      border-radius: var(--radius-md);
      width: 90%;
      max-width: 600px;
      max-height: 80vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem;
      border-bottom: 1px solid var(--border-color);
    }
    
    .modal-header h3 {
      margin: 0;
    }
    
    .modal-body {
      padding: 1rem;
      overflow-y: auto;
    }
    
    .close-btn {
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      color: var(--text-secondary);
    }
    
    .embed-file-list {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 0.5rem;
    }
    
    .embed-file-item {
      display: flex;
      align-items: center;
      padding: 0.5rem;
      border: 1px solid var(--border-color);
      border-radius: var(--radius-sm);
      cursor: pointer;
      transition: background-color 0.2s;
    }
    
    .embed-file-item:hover {
      background-color: var(--bg-surface-hover);
    }
    
    .embed-file-item .material-icons {
      margin-right: 0.5rem;
    }

    .relative {
      position: relative;
    }

    .avatar-upload-label {
      position: absolute;
      bottom: 0;
      right: 0;
      background-color: rgba(0,0,0,0.6);
      color: white;
      padding: 0.25rem;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .avatar-upload-label .material-icons {
      font-size: 1rem;
    }

    .editable-field[contenteditable="true"] {
      border-bottom: 2px solid var(--primary);
      outline: none;
    }

    .btn-icon {
      background: none;
      border: none;
      padding: 0.25rem;
      cursor: pointer;
      color: var(--text-secondary);
    }
  </style>
</head>
<body>
  <header>
    <div class="container">
      <!-- Navigation will be inserted by JavaScript -->
    </div>
  </header>

  <main class="container">
    <div id="error-container"></div>
    <div class="drawer-title">
      <h1>
        <span class="material-icons" aria-hidden="true">folder_shared</span>
        Your Drawer
      </h1>
      <p>Your personal space in the Rel</p>
    </div>

    <!-- User profile / Drawer container -->
    <div class="drawer-container">
      <div class="drawer-header">
        <div class="flex gap-4 items-center">
          <div class="drawer-icon relative">
            <img id="user-avatar" src="./icons/user-default.svg" alt="User avatar" class="avatar-large">
            <label for="avatar-upload" class="avatar-upload-label">
              <span class="material-icons">edit</span>
            </label>
            <input type="file" id="avatar-upload" class="hidden" accept="image/*">
          </div>
          <div>
            <div class="flex items-center gap-2">
              <h2 id="user-name" contenteditable="false" class="editable-field">Username</h2>
              <button id="edit-name-btn" class="btn btn-icon">
                <span class="material-icons">edit</span>
              </button>
              <button id="save-name-btn" class="btn btn-icon hidden">
                <span class="material-icons">save</span>
              </button>
            </div>
            <p class="drawer-subtitle">Joined: <span id="user-joined">July 12, 2025</span></p>
          </div>
        </div>
        <button id="preview-drawer-btn" class="btn btn-secondary">
          <span class="material-icons">visibility</span>
          Preview Public Drawer
        </button>
      </div>

      <!-- Communique (customizable public message) -->
      <h3>Communique</h3>
      <div id="communique-editor-container">
        <div id="communique-toolbar" class="flex gap-2 mb-2">
          <button class="btn btn-small" id="format-bold" title="Bold">
            <span class="material-icons">format_bold</span>
          </button>
          <button class="btn btn-small" id="format-italic" title="Italic">
            <span class="material-icons">format_italic</span>
          </button>
          <button class="btn btn-small" id="format-underline" title="Underline">
            <span class="material-icons">format_underline</span>
          </button>
          <button class="btn btn-small" id="format-link" title="Insert Link">
            <span class="material-icons">link</span>
          </button>
          <button class="btn btn-small" id="format-image" title="Insert Image">
            <span class="material-icons">image</span>
          </button>
          <button class="btn btn-small" id="format-embed" title="Embed File">
            <span class="material-icons">code</span>
          </button>
          <div class="flex-1"></div>
          <button class="btn btn-small" id="toggle-preview" title="Toggle Preview">
            <span class="material-icons">visibility</span> Preview
          </button>
          <button class="btn btn-small btn-secondary" id="save-communique" title="Save">
            <span class="material-icons">save</span> Save
          </button>
        </div>
        <div 
          id="communique" 
          class="communique" 
          contenteditable="true" 
          data-placeholder="Add your communique here. This is your public message to visitors of your drawer. You can format this area with HTML, add links, images, and express yourself. Embed your files to showcase your work."
        ></div>
        <div id="communique-preview" class="communique hidden"></div>
        <p class="text-sm text-muted mt-1">
          Tip: This is your public profile that other users see. You can use HTML formatting and embed your uploaded files.
        </p>
      </div>

      <!-- User Stats -->
      <div class="flex gap-4 mb-4">
        <div class="card flex-1">
          <h4>Files Shared</h4>
          <p id="files-count" class="text-center" style="font-size: 2rem;">0</p>
        </div>
        <div class="card flex-1">
          <h4>Files Archived</h4>
          <p id="archived-count" class="text-center" style="font-size: 2rem;">0</p>
        </div>
        <div class="card flex-1">
          <h4>Connections</h4>
          <p id="connections-count" class="text-center" style="font-size: 2rem;">0</p>
        </div>
      </div>

      <!-- "Lurker in the Mist" mode toggle -->
      <div class="lurker-mode-toggle">
        <label for="lurker-mode">
          <span class="material-icons">visibility_off</span>
          Lurker in the Mist Mode
        </label>
        <input type="checkbox" id="lurker-mode">
        <div id="lurker-status" class="lurker-mode-status">Inactive</div>
      </div>
      <small>When active, your presence in the association web is minimized and your drawer appears with reduced visibility.</small>

      <!-- Theme Selector -->
      <div class="theme-selector-container mt-4">
        <label for="theme-selector">
          <span class="material-icons">palette</span>
          Theme
        </label>
        <select id="theme-selector" class="select-input">
          <option value="system">System Default</option>
          <option value="light">Light</option>
          <option value="dark">Dark</option>
        </select>
        <small>Choose how your drawer and the site appears to you.</small>
      </div>
    </div>

    <!-- File Management Tabs -->
    <div class="card mt-4">
      <div class="flex border-bottom p-2">
        <button id="tab-all" class="btn btn-secondary active">All Files</button>
        <button id="tab-public" class="btn btn-secondary">Public</button>
        <button id="tab-private" class="btn btn-secondary">Private</button>
        <button id="tab-expiring" class="btn btn-secondary">Expiring Soon</button>
        <button id="tab-archived" class="btn btn-secondary">Archived</button>
      </div>

      <!-- File management toolbar -->
      <div class="flex gap-2 p-2 border-bottom">
        <a href="./upload.html" class="btn">
          <span class="material-icons">cloud_upload</span>
          Upload New
        </a>
        <button id="btn-refresh" class="btn btn-secondary">
          <span class="material-icons">refresh</span>
          Refresh
        </button>
        <div class="flex-1"></div>
        <div class="search-input-group">
          <input type="text" id="file-search" placeholder="Search your files..." class="search-input">
          <button class="search-button">
            <span class="material-icons">search</span>
          </button>
        </div>
      </div>

      <!-- Files container -->
      <div id="files-container">
        <div class="p-4 text-center" id="loading-placeholder">
          <span class="material-icons" style="font-size: 48px;">hourglass_top</span>
          <p>Loading your files...</p>
        </div>

        <!-- Empty state -->
        <div id="empty-state" class="p-4 text-center hidden">
          <span class="material-icons" style="font-size: 48px;">sentiment_dissatisfied</span>
          <h3>No files found</h3>
          <p>Your drawer is empty. Upload some files to get started!</p>
          <a href="./upload.html" class="btn mt-4">
            <span class="material-icons">cloud_upload</span>
            Upload Your First File
          </a>
        </div>

        <!-- File grid will be populated by JavaScript -->
        <div id="file-grid" class="file-grid p-4 hidden"></div>

        <!-- Pagination -->
        <div id="pagination" class="flex justify-center gap-2 p-4 hidden">
          <button id="prev-page" class="btn btn-secondary">
            <span class="material-icons">chevron_left</span>
            Previous
          </button>
          <span id="page-indicator">Page 1</span>
          <button id="next-page" class="btn btn-secondary">
            Next
            <span class="material-icons">chevron_right</span>
          </button>
        </div>
      </div>
    </div>

    <!-- Connections and RPC (Recent Private Cache) -->
    <div class="mt-4">
      <h2>Your Connections</h2>
      
      <div class="card mb-4">
        <h3>
          <span class="material-icons">people</span>
          Connection Requests
        </h3>
        
        <div id="connection-requests" class="p-4">
          <!-- Will be populated by JavaScript -->
          <p class="text-center">No pending connection requests</p>
        </div>
      </div>
      
      <div class="rpc-container">
        <div class="rpc-header">
          <h3>
            <span class="material-icons">folder_special</span>
            Recent Private Cache
          </h3>
          <p>Files shared directly with you appear here</p>
        </div>
        
        <div id="rpc-items" class="file-grid p-4">
          <!-- Will be populated by JavaScript -->
          <p class="text-center">Your private cache is empty</p>
        </div>
      </div>
    </div>
  </main>

  <footer class="footer">
    <p class="footer-motto text-accent">"the rel is what you make it"</p>
    <div class="footer-links">
      <a href="index.html">Home</a> | 
      <a href="help.html">Help</a> | 
      <a href="about.html">About</a> | 
      <a href="sitemap.html">Site Map</a>
    </div>
  </footer>

  <!-- File Item Template -->
  <template id="file-item-template">
    <div class="file-item">
      <div class="file-icon">
        <span class="material-icons"></span>
      </div>
      <div class="file-name"></div>
      <div class="file-expiry"></div>
    </div>
  </template>

  <!-- Include DOMPurify for HTML sanitization -->
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"></script>
  <script type="module" src="./js/drawer-page.js"></script>
</body>
</html>
