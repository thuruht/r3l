<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>R3L:F — Your Feed</title>
  <link rel="stylesheet" href="./css/rel-f-global.css" />
  <link rel="stylesheet" href="./css/rel-f-accent.css" />
  <script src="vendor/d3/d3.v7.min.js" defer></script>
</head>
<body>
  <header class="container">
    <!-- Navigation inserted by JS -->
  </header>
  <main class="container">
    <h1>Your Chronological Feed</h1>
    <p class="text-muted">Strictly latest-first from your connections and you. No ranking, no boosts.</p>
    <div id="feed" class="feed-list" style="display:flex;flex-direction:column;gap:1rem;margin-top:1rem;"></div>
    <div id="feed-more" style="margin:1rem 0;">
      <button id="load-more" class="btn">Load more</button>
    </div>
  </main>
  <footer class="footer">
    <div class="footer-links">
      <a href="index.html">Home</a> | <a href="help.html">Help</a>
    </div>
  </footer>
  <script type="module">
    import { NavigationBar } from './js/components/navigation.js';
    import { apiGet, API_ENDPOINTS } from './js/utils/api-helper.js';

    NavigationBar.init('feed');

    let offset = 0;
    const limit = 20;
    const feedEl = document.getElementById('feed');
    const btn = document.getElementById('load-more');

    async function render(items) {
      for (const item of items) {
        const card = document.createElement('article');
        card.className = 'card card-accent';
        card.innerHTML = `
          <div class="card-header" style="display:flex;align-items:center;gap:.75rem;">
            <img src="${item.avatar_url || '/icons/avatar.svg'}" alt="avatar" width="32" height="32" style="border-radius:50%"/>
            <div>
              <div class="text-accent">${item.display_name || item.username || 'Unknown'}</div>
              <div class="text-muted" style="font-size:.85em;">${new Date(item.created_at).toLocaleString()}</div>
            </div>
          </div>
          <div class="card-body">
            <h3>${escapeHtml(item.title || '(untitled)')}</h3>
            ${item.description ? `<p>${escapeHtml(item.description)}</p>` : ''}
            <div class="text-muted" style="font-size:.85em;">${item.category || ''} • ${item.tags || ''}</div>
          </div>
        `;
        card.addEventListener('click', () => {
          window.location.href = `/content.html?id=${item.id}`;
        });
        feedEl.appendChild(card);
      }
    }

    function escapeHtml(str) {
      return String(str)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
    }

    async function load() {
      btn.disabled = true;
      const data = await apiGet(API_ENDPOINTS.CONTENT.FEED, { limit, offset });
      if (data && data.items) {
        await render(data.items);
        offset += data.items.length;
        if (!data.pagination || data.items.length < limit) {
          btn.style.display = 'none';
        } else {
          btn.disabled = false;
        }
      } else {
        btn.style.display = 'none';
      }
    }

    btn.addEventListener('click', load);
    load();
  </script>
  
</body>
</html>
