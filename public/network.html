<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Network - R3L:F</title>
  <link rel="stylesheet" href="css/rel-f-global.css">
  <script src="vendor/d3/d3.v7.min.js"></script>
  <style>
    .network-container {
      width: 100%;
      height: 80vh;
      background: var(--bg-container);
      border-radius: var(--radius-md);
      position: relative;
    }
    .controls {
      position: absolute;
      top: 1rem;
      right: 1rem;
      background: rgba(0,0,0,0.7);
      padding: 1rem;
      border-radius: var(--radius-md);
      z-index: 10;
    }
    .controls label {
      display: block;
      margin-bottom: 0.5rem;
      color: white;
    }
    .legend {
      position: absolute;
      bottom: 1rem;
      left: 1rem;
      background: rgba(0,0,0,0.7);
      padding: 1rem;
      border-radius: var(--radius-md);
      color: white;
      z-index: 10;
    }
    .legend-item {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 0.5rem;
    }
    .legend-color {
      width: 20px;
      height: 20px;
      border-radius: 50%;
    }
    .node {
      cursor: pointer;
      stroke: #fff;
      stroke-width: 1.5px;
    }
    .link {
      stroke: var(--accent-purple);
      stroke-opacity: 0.6;
    }
    .node-label {
      font-size: 10px;
      pointer-events: none;
      fill: var(--text-primary);
    }
  </style>
</head>
<body>
  <header>
    <div class="container"></div>
  </header>
  <main class="container">
    <h1>Association Web</h1>
    <p class="text-muted">Explore connections between users and content</p>
    <div class="network-container">
      <svg id="networkSvg"></svg>
      <div class="controls">
        <label>
          <input type="checkbox" id="showLabels" checked> Show Labels
        </label>
      </div>
      <div class="legend">
        <h4 style="margin-top:0;">Legend</h4>
        <div class="legend-item">
          <div class="legend-color" style="background:#a278ff;"></div>
          <span>Users</span>
        </div>
        <div class="legend-item">
          <div class="legend-color" style="background:#7fd8d8;"></div>
          <span>Content</span>
        </div>
      </div>
    </div>
  </main>
  <footer class="footer">
    <p class="footer-motto text-accent">"the rel is what you make it"</p>
  </footer>
  <script type="module">
    import { NavigationBar } from './js/components/navigation.js';
    NavigationBar.init('network');

    async function loadNetwork() {
      if (!window.r3l?.isAuthenticated()) {
        return;
      }

      try {
        const data = await window.r3l.apiGet('/api/network');
        renderNetwork(data);
      } catch (error) {
        console.error('Failed to load network:', error);
        // Render sample data
        renderNetwork({
          nodes: d3.range(20).map(i => ({
            id: `node-${i}`,
            label: `Node ${i}`,
            type: i < 5 ? 'user' : 'content'
          })),
          links: []
        });
      }
    }

    function renderNetwork(data) {
      const svg = d3.select('#networkSvg');
      const container = document.querySelector('.network-container');
      const width = container.clientWidth;
      const height = container.clientHeight;

      svg.attr('viewBox', [0, 0, width, height]);
      svg.selectAll('*').remove();

      const g = svg.append('g');

      // Create links if they don't exist
      if (!data.links || data.links.length === 0) {
        data.links = [];
        for (let i = 0; i < data.nodes.length; i++) {
          for (let j = i + 1; j < data.nodes.length; j++) {
            if (Math.random() < 0.15) {
              data.links.push({
                source: data.nodes[i].id,
                target: data.nodes[j].id
              });
            }
          }
        }
      }

      const simulation = d3.forceSimulation(data.nodes)
        .force('link', d3.forceLink(data.links).id(d => d.id).distance(100))
        .force('charge', d3.forceManyBody().strength(-300))
        .force('center', d3.forceCenter(width / 2, height / 2))
        .force('collision', d3.forceCollide().radius(30));

      const link = g.append('g')
        .selectAll('line')
        .data(data.links)
        .join('line')
        .attr('class', 'link')
        .attr('stroke-width', 2);

      const node = g.append('g')
        .selectAll('circle')
        .data(data.nodes)
        .join('circle')
        .attr('class', 'node')
        .attr('r', d => d.type === 'user' ? 8 : 6)
        .attr('fill', d => d.type === 'user' ? '#a278ff' : '#7fd8d8')
        .call(d3.drag()
          .on('start', dragstarted)
          .on('drag', dragged)
          .on('end', dragended))
        .on('click', (event, d) => {
          console.log('Clicked:', d);
        });

      const label = g.append('g')
        .selectAll('text')
        .data(data.nodes)
        .join('text')
        .attr('class', 'node-label')
        .attr('text-anchor', 'middle')
        .attr('dy', -12)
        .text(d => d.label);

      simulation.on('tick', () => {
        link
          .attr('x1', d => d.source.x)
          .attr('y1', d => d.source.y)
          .attr('x2', d => d.target.x)
          .attr('y2', d => d.target.y);

        node
          .attr('cx', d => d.x)
          .attr('cy', d => d.y);

        label
          .attr('x', d => d.x)
          .attr('y', d => d.y);
      });

      // Zoom
      const zoom = d3.zoom()
        .scaleExtent([0.1, 4])
        .on('zoom', (event) => {
          g.attr('transform', event.transform);
        });

      svg.call(zoom);

      // Show/hide labels
      document.getElementById('showLabels').addEventListener('change', (e) => {
        label.style('display', e.target.checked ? 'block' : 'none');
      });

      function dragstarted(event) {
        if (!event.active) simulation.alphaTarget(0.3).restart();
        event.subject.fx = event.subject.x;
        event.subject.fy = event.subject.y;
      }

      function dragged(event) {
        event.subject.fx = event.x;
        event.subject.fy = event.y;
      }

      function dragended(event) {
        if (!event.active) simulation.alphaTarget(0);
        event.subject.fx = null;
        event.subject.fy = null;
      }
    }

    if (typeof d3 !== 'undefined') {
      loadNetwork();
    }
  </script>
</body>
</html>
