<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Notifications - R3L:F</title>
  <link rel="stylesheet" href="css/rel-f-global.css">
  <style>
    .notifications-container {
      max-width: 800px;
      margin: 2rem auto;
    }
    .notification-filters {
      display: flex;
      gap: 1rem;
      margin-bottom: 1.5rem;
      flex-wrap: wrap;
    }
    .filter-btn {
      padding: 0.5rem 1rem;
      border: 1px solid var(--border-primary);
      background: var(--bg-container);
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: all 0.2s;
    }
    .filter-btn.active {
      background: var(--accent-purple);
      color: white;
      border-color: var(--accent-purple);
    }
    .filter-btn:hover {
      transform: translateY(-2px);
    }
    .notification-item {
      background: var(--bg-container);
      border-radius: var(--radius-md);
      padding: 1rem;
      margin-bottom: 1rem;
      border-left: 4px solid var(--accent-purple);
      transition: all 0.2s;
    }
    .notification-item.unread {
      background: var(--bg-subtle);
      font-weight: 600;
    }
    .notification-item:hover {
      transform: translateX(4px);
      box-shadow: var(--shadow-medium);
    }
    .notification-header {
      display: flex;
      justify-content: space-between;
      align-items: start;
      margin-bottom: 0.5rem;
    }
    .notification-title {
      font-weight: 600;
      color: var(--text-primary);
    }
    .notification-time {
      font-size: 0.85rem;
      color: var(--text-muted);
    }
    .notification-content {
      color: var(--text-secondary);
      margin-bottom: 0.5rem;
    }
    .notification-actions {
      display: flex;
      gap: 0.5rem;
    }
    .notification-actions button {
      padding: 0.25rem 0.75rem;
      font-size: 0.85rem;
      border: none;
      background: var(--bg-subtle);
      color: var(--text-primary);
      border-radius: var(--radius-sm);
      cursor: pointer;
    }
    .notification-actions button:hover {
      background: var(--accent-purple);
      color: white;
    }
    .category-badge {
      display: inline-block;
      padding: 0.25rem 0.5rem;
      border-radius: 12px;
      font-size: 0.75rem;
      font-weight: 600;
      margin-left: 0.5rem;
    }
    .category-general { background: var(--accent-purple); color: white; }
    .category-social { background: var(--accent-green); color: white; }
    .category-content { background: var(--accent-blue); color: white; }
    .category-system { background: var(--text-muted); color: white; }
    .empty-state {
      text-align: center;
      padding: 3rem;
      color: var(--text-muted);
    }
    .bulk-actions {
      display: flex;
      gap: 1rem;
      margin-bottom: 1rem;
    }
  </style>
</head>
<body>
  <header>
    <div class="container"></div>
  </header>
  <main class="container">
    <div class="notifications-container">
      <h1>Notifications</h1>
      
      <div class="bulk-actions">
        <button class="btn btn-secondary" id="markAllRead">Mark All Read</button>
        <button class="btn btn-secondary" id="clearRead">Clear Read</button>
      </div>
      
      <div class="notification-filters" id="filters">
        <button class="filter-btn active" data-category="all">All</button>
        <button class="filter-btn" data-category="general">General</button>
        <button class="filter-btn" data-category="social">Social</button>
        <button class="filter-btn" data-category="content">Content</button>
        <button class="filter-btn" data-category="system">System</button>
      </div>
      
      <div id="notificationsList"></div>
    </div>
  </main>
  <footer class="footer">
    <p class="footer-motto text-accent">"the rel is what you make it"</p>
  </footer>
  <script type="module">
    import { NavigationBar } from './js/components/navigation.js';
    NavigationBar.init('notifications');

    let currentFilter = 'all';
    let allNotifications = [];

    async function loadNotifications() {
      if (!window.r3l?.isAuthenticated()) {
        window.location.href = '/auth/login.html';
        return;
      }

      try {
        const notifications = await window.r3l.apiGet('/api/notifications');
        allNotifications = notifications;
        renderNotifications();
      } catch (error) {
        console.error('Failed to load notifications:', error);
        document.getElementById('notificationsList').innerHTML = 
          '<div class="empty-state">Failed to load notifications</div>';
      }
    }

    function renderNotifications() {
      const filtered = currentFilter === 'all' 
        ? allNotifications 
        : allNotifications.filter(n => n.category === currentFilter);

      const list = document.getElementById('notificationsList');
      
      if (filtered.length === 0) {
        list.innerHTML = '<div class="empty-state">No notifications</div>';
        return;
      }

      list.innerHTML = filtered.map(n => {
        const time = new Date(n.createdAt).toLocaleString();
        const category = n.category || 'general';
        
        return `
          <div class="notification-item ${n.isRead ? '' : 'unread'}" data-id="${n.id}">
            <div class="notification-header">
              <div>
                <span class="notification-title">${n.title}</span>
                <span class="category-badge category-${category}">${category}</span>
              </div>
              <span class="notification-time">${time}</span>
            </div>
            ${n.content ? `<div class="notification-content">${n.content}</div>` : ''}
            <div class="notification-actions">
              ${n.actionUrl ? `<button onclick="window.location.href='${n.actionUrl}'">View</button>` : ''}
              ${!n.isRead ? `<button onclick="markRead('${n.id}')">Mark Read</button>` : ''}
              <button onclick="deleteNotification('${n.id}')">Delete</button>
            </div>
          </div>
        `;
      }).join('');
    }

    window.markRead = async (id) => {
      try {
        await window.r3l.apiPost('/api/notifications/mark-read', { ids: [id] });
        const notification = allNotifications.find(n => n.id === id);
        if (notification) notification.isRead = 1;
        renderNotifications();
      } catch (error) {
        console.error('Failed to mark as read:', error);
      }
    };

    window.deleteNotification = async (id) => {
      try {
        await window.r3l.apiDelete(`/api/notifications/${id}`);
        allNotifications = allNotifications.filter(n => n.id !== id);
        renderNotifications();
      } catch (error) {
        console.error('Failed to delete notification:', error);
      }
    };

    document.getElementById('markAllRead')?.addEventListener('click', async () => {
      try {
        await window.r3l.apiPost('/api/notifications/mark-all-read', {});
        allNotifications.forEach(n => n.isRead = 1);
        renderNotifications();
      } catch (error) {
        console.error('Failed to mark all as read:', error);
      }
    });

    document.getElementById('clearRead')?.addEventListener('click', async () => {
      const readIds = allNotifications.filter(n => n.isRead).map(n => n.id);
      for (const id of readIds) {
        try {
          await window.r3l.apiDelete(`/api/notifications/${id}`);
        } catch (error) {
          console.error('Failed to delete notification:', error);
        }
      }
      allNotifications = allNotifications.filter(n => !n.isRead);
      renderNotifications();
    });

    // Filter buttons
    document.querySelectorAll('.filter-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        currentFilter = btn.dataset.category;
        renderNotifications();
      });
    });

    loadNotifications();
    
    // Refresh every 30 seconds
    setInterval(loadNotifications, 30000);
  </script>
</body>
</html>
