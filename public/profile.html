<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>R3L:F - Your Profile</title>
  <link rel="stylesheet" href="css/rel-f-global.css">
  <script src="js/font-loader.js" defer></script>
  <style>
    .profile-container {
      max-width: 800px;
      margin: 2rem auto;
      padding: 2rem;
      background-color: var(--surface-color);
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    
    .profile-header {
      display: flex;
      align-items: center;
      gap: 1.5rem;
      margin-bottom: 2rem;
      padding-bottom: 1.5rem;
      border-bottom: 1px solid var(--border-color);
    }
    
    .profile-avatar {
      width: 100px;
      height: 100px;
      border-radius: 50%;
      object-fit: cover;
      background-color: var(--accent-color-light);
    }
    
    .profile-avatar-container {
      position: relative;
      width: 100px;
      height: 100px;
    }
    
    .avatar-upload-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      border-radius: 50%;
      display: flex;
      justify-content: center;
      align-items: center;
      cursor: pointer;
      opacity: 0;
      transition: opacity 0.2s ease;
    }
    
    .profile-avatar-container:hover .avatar-upload-overlay {
      opacity: 1;
    }
    
    .avatar-upload-button {
      color: white;
      cursor: pointer;
    }
    
    .avatar-upload-button .material-icons {
      font-size: 28px;
    }
    
    .profile-info {
      flex-grow: 1;
    }
    
    .profile-name {
      margin: 0 0 0.5rem 0;
      font-size: 1.5rem;
    }
    
    .profile-username {
      margin: 0;
      color: var(--text-secondary);
      font-size: 1rem;
    }
    
    .profile-joined {
      margin: 0.5rem 0 0 0;
      font-size: 0.9rem;
      color: var(--text-secondary);
    }
    
    .profile-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 1rem;
      margin-bottom: 2rem;
    }
    
    .stat-card {
      padding: 1rem;
      background-color: var(--background-color);
      border-radius: 6px;
      text-align: center;
    }
    
    .stat-value {
      font-size: 1.5rem;
      font-weight: 700;
      margin: 0;
      color: var(--accent-color);
    }
    
    .stat-label {
      font-size: 0.9rem;
      margin: 0.25rem 0 0 0;
      color: var(--text-secondary);
    }
    
    .profile-section {
      margin-bottom: 2rem;
    }
    
    .section-title {
      font-size: 1.25rem;
      margin: 0 0 1rem 0;
      padding-bottom: 0.5rem;
      border-bottom: 1px solid var(--border-color);
    }
    
    .auth-providers {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      margin-top: 1rem;
    }
    
    .auth-provider {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 1rem;
      background-color: var(--background-color);
      border-radius: 4px;
      border: 1px solid var(--border-color);
    }
    
    .auth-provider img {
      width: 20px;
      height: 20px;
    }
    
    .action-buttons {
      display: flex;
      gap: 1rem;
      margin-top: 2rem;
    }
    
    .edit-profile-btn {
      padding: 0.5rem 1rem;
      background-color: var(--accent-color);
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    
    .recovery-key-btn {
      padding: 0.5rem 1rem;
      background-color: var(--warning-color, #f97316);
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    
    .logout-btn {
      padding: 0.5rem 1rem;
      background-color: transparent;
      color: var(--text-primary);
      border: 1px solid var(--border-color);
      border-radius: 4px;
      cursor: pointer;
    }
    
    .not-authenticated {
      text-align: center;
      padding: 3rem;
    }
    
    .not-authenticated p {
      margin-bottom: 2rem;
    }
    
    /* Modal Styles */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0, 0, 0, 0.7);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    
    .modal {
      background-color: var(--surface-color);
      border-radius: 8px;
      padding: 2rem;
      max-width: 500px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
    }
    
    .modal-title {
      margin-top: 0;
      margin-bottom: 1rem;
      color: var(--accent-color);
    }
    
    .modal-content {
      margin-bottom: 1.5rem;
    }
    
    .recovery-key-display {
      background-color: var(--background-color);
      padding: 1rem;
      border-radius: 6px;
      font-family: monospace;
      font-size: 1.2rem;
      text-align: center;
      margin: 1rem 0;
      -webkit-user-select: all;
      user-select: all;
      border: 1px dashed var(--border-color);
    }
    
    .modal-actions {
      display: flex;
      justify-content: space-between;
    }
    
    .modal-warning {
      color: var(--warning-color, #f97316);
      font-weight: bold;
      margin-bottom: 1rem;
    }
    
    .copy-btn {
      background-color: var(--accent-color);
      color: white;
      border: none;
      border-radius: 4px;
      padding: 0.5rem 1rem;
      cursor: pointer;
    }
    
    .close-btn {
      background-color: var(--text-secondary);
      color: white;
      border: none;
      border-radius: 4px;
      padding: 0.5rem 1rem;
      cursor: pointer;
    }
    
    .hidden {
      display: none;
    }
    
    /* Map Points Section */
    .map-points-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 1rem;
      margin: 1rem 0;
    }
    
    .map-point-card {
      background-color: var(--bg-container);
      border-radius: var(--radius-md);
      padding: 1rem;
      border: 1px solid var(--border-primary);
      transition: all var(--transition-fast);
    }
    
    .map-point-card:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-medium);
    }
    
    .map-point-title {
      font-weight: 600;
      margin: 0 0 0.5rem 0;
      color: var(--accent-green);
    }
    
    .map-point-coords {
      font-family: var(--font-mono);
      font-size: 0.8rem;
      color: var(--text-secondary);
      margin-bottom: 0.5rem;
    }
    
    .map-point-desc {
      font-size: 0.9rem;
      margin: 0;
      color: var(--text-primary);
    }
    
    .map-point-actions {
      display: flex;
      justify-content: space-between;
      margin-top: 0.75rem;
      padding-top: 0.5rem;
      border-top: 1px solid var(--border-subtle);
    }
    
    .map-point-actions button {
      background: none;
      border: none;
      cursor: pointer;
      color: var(--text-muted);
      transition: color var(--transition-fast);
      padding: 0.25rem;
    }
    
    .map-point-actions button:hover {
      color: var(--accent-lavender);
    }
    
    .map-actions {
      display: flex;
      gap: 1rem;
      margin-top: 1.5rem;
    }
    
    .empty-state {
      color: var(--text-muted);
      text-align: center;
      padding: 1rem;
      font-style: italic;
    }
    
    /* Settings Styles */
    .settings-grid {
      display: grid;
      gap: 1.5rem;
    }
    
    .setting-group {
      background-color: var(--bg-container);
      border-radius: var(--radius-md);
      padding: 1.25rem;
      border: 1px solid var(--border-primary);
    }
    
    .setting-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.75rem;
    }
    
    .setting-title {
      margin: 0;
      font-size: 1.1rem;
      font-weight: 600;
    }
    
    .setting-description {
      margin: 0 0 1rem 0;
      color: var(--text-secondary);
      font-size: 0.95rem;
    }
    
    .setting-note {
      margin: 0.5rem 0 0 0;
      color: var(--text-muted);
      font-size: 0.85rem;
      font-style: italic;
    }
    
    .setting-control {
      margin: 1rem 0;
    }
    
    .setting-actions {
      display: flex;
      justify-content: flex-end;
      margin-top: 1rem;
    }
    
    /* Toggle Switch */
    .toggle-switch {
      position: relative;
      display: inline-block;
      width: 50px;
      height: 24px;
    }
    
    .toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    
    .toggle-slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: var(--bg-subtle);
      transition: .4s;
      border-radius: 34px;
    }
    
    .toggle-slider:before {
      position: absolute;
      content: "";
      height: 18px;
      width: 18px;
      left: 3px;
      bottom: 3px;
      background-color: white;
      transition: .4s;
      border-radius: 50%;
    }
    
    input:checked + .toggle-slider {
      background-color: var(--accent-color);
    }
    
    input:focus + .toggle-slider {
      box-shadow: 0 0 1px var(--accent-color);
    }
    
    input:checked + .toggle-slider:before {
      transform: translateX(26px);
    }
    
    /* Slider with value */
    .slider-with-value {
      display: flex;
      align-items: center;
      gap: 1rem;
    }
    
    .slider-with-value input[type="range"] {
      flex: 1;
    }
    
    /* Radio Group */
    .radio-group {
      display: flex;
      gap: 1rem;
    }
    
    .radio-group label {
      display: flex;
      align-items: center;
      gap: 0.35rem;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <header>
    <div class="container">
      <!-- Navigation will be inserted by JavaScript -->
    </div>
  </header>

  <main>
    <div class="container">
      <h1>Your Profile</h1>
      
      <!-- Loading state -->
      <div id="loading" class="profile-container">
        <p>Loading profile data...</p>
      </div>
      
      <!-- Not authenticated state -->
      <div id="not-authenticated" class="profile-container not-authenticated hidden">
        <h2>Not Authenticated</h2>
        <p>You need to log in to view your profile.</p>
        <div class="auth-buttons">
          <a href="/auth/login.html" class="primary-button">Log In</a>
          <a href="/auth/register.html" class="secondary-button">Create Account</a>
        </div>
      </div>
      
      <!-- Authenticated state -->
      <div id="profile-data" class="profile-container hidden">
        <div class="profile-header">
          <div class="profile-avatar-container">
            <div id="profile-avatar" class="profile-avatar"></div>
            <div class="avatar-upload-overlay hidden" id="avatar-upload-overlay">
              <label for="avatar-upload" class="avatar-upload-button">
                <span class="material-icons">photo_camera</span>
              </label>
              <input type="file" id="avatar-upload" accept="image/*" class="hidden">
            </div>
          </div>
          <div class="profile-info">
            <h2 id="profile-name" class="profile-name">User Name</h2>
            <p id="profile-username" class="profile-username">@username</p>
            <p id="profile-joined" class="profile-joined">Joined on Jan 1, 2025</p>
          </div>
        </div>
        
        <div class="profile-stats">
          <div class="stat-card">
            <p id="stat-contributions" class="stat-value">0</p>
            <p class="stat-label">Content Items</p>
          </div>
          <div class="stat-card">
            <p id="stat-drawers" class="stat-value">0</p>
            <p class="stat-label">Drawers</p>
          </div>
          <div class="stat-card">
            <p id="stat-connections" class="stat-value">0</p>
            <p class="stat-label">Connections</p>
          </div>
        </div>
        
        <div class="profile-section">
          <h3 class="section-title">Authentication Providers</h3>
          <div id="auth-providers" class="auth-providers">
            <!-- Will be populated by JavaScript -->
          </div>
        </div>
        
        <!-- Visibility & Privacy Settings Section -->
        <div class="profile-section">
          <h3 class="section-title">Visibility & Privacy Settings</h3>
          <div class="settings-grid">
            <!-- Lurker in the Mist Mode -->
            <div class="setting-group">
              <div class="setting-header">
                <h4 class="setting-title">Lurker in the Mist Mode</h4>
                <label class="toggle-switch">
                  <input type="checkbox" id="lurker-mode-toggle">
                  <span class="toggle-slider"></span>
                </label>
              </div>
              <p class="setting-description">Low-visibility status for privacy-conscious browsing. Appears muted in the association web with no clear associations.</p>
              
              <div class="setting-control">
                <label for="lurker-randomness">Search Randomness Level:</label>
                <div class="slider-with-value">
                  <input type="range" id="lurker-randomness" min="0" max="100" step="5" value="50">
                  <span id="lurker-randomness-value">50%</span>
                </div>
              </div>
              <p class="setting-note">Higher randomness means more diverse but less relevant search results.</p>
            </div>
            
            <!-- Location Visibility -->
            <div class="setting-group">
              <div class="setting-header">
                <h4 class="setting-title">Show Location by Default</h4>
                <label class="toggle-switch">
                  <input type="checkbox" id="location-visibility-toggle">
                  <span class="toggle-slider"></span>
                </label>
              </div>
              <p class="setting-description">When enabled, your location will be visible on the map to other users by default.</p>
            </div>
            
            <!-- Default Content Visibility -->
            <div class="setting-group">
              <div class="setting-header">
                <h4 class="setting-title">Default Content Visibility</h4>
                <div class="radio-group">
                  <label>
                    <input type="radio" name="default-visibility" value="public" checked>
                    <span>Public</span>
                  </label>
                  <label>
                    <input type="radio" name="default-visibility" value="private">
                    <span>Private</span>
                  </label>
                </div>
              </div>
              <p class="setting-description">Choose whether your new content is public or private by default.</p>
            </div>
            
            <div class="setting-actions">
              <button id="save-privacy-settings" class="btn btn-accent">Save Settings</button>
            </div>
          </div>
        </div>
        
        <!-- Map Points Section -->
        <div class="profile-section">
          <h3 class="section-title">Your Map Points</h3>
          <div id="map-points-container">
            <p class="empty-state">You haven't added any map points yet.</p>
            <div id="user-map-points" class="map-points-grid"></div>
            <div class="map-actions">
              <a href="/map.html?action=add-point" class="btn btn-accent">
                <span class="material-icons">add_location</span>
                Add Map Point
              </a>
              <a href="/map.html" class="btn btn-secondary">
                <span class="material-icons">map</span>
                View Map
              </a>
            </div>
          </div>
        </div>
        
        <div class="action-buttons">
          <button id="edit-profile-btn" class="edit-profile-btn">Edit Profile</button>
          <button id="generate-recovery-key-btn" class="recovery-key-btn">Generate Recovery Key</button>
          <button id="logout-btn" class="logout-btn">Log Out</button>
        </div>
      </div>
      
      <!-- Recovery Key Modal -->
      <div id="recovery-key-modal" class="modal-overlay hidden">
        <div class="modal">
          <h2 class="modal-title">Your New Recovery Key</h2>
          <div class="modal-content">
            <p class="modal-warning">IMPORTANT: Save this recovery key in a secure location. It will only be shown once!</p>
            <p>If you forget your password, you will need this key to recover your account.</p>
            <div id="recovery-key-display" class="recovery-key-display">
              Loading...
            </div>
            <p>Please copy this key and store it securely. It cannot be retrieved later.</p>
          </div>
          <div class="modal-actions">
            <button id="copy-recovery-key-btn" class="copy-btn">Copy to Clipboard</button>
            <button id="close-modal-btn" class="close-btn">I've Saved It</button>
          </div>
        </div>
      </div>
    </div>
  </main>

  <footer>
    <div class="container">
      <p>R3L:F - Relational Ephemeral Filenet</p>
      <p>Anti-algorithmic, Ephemeral by Default, Community-driven</p>
    </div>
  </footer>

  <script type="module">
    import { NavigationBar } from './js/components/navigation.js';

    document.addEventListener('DOMContentLoaded', function() {
      // Initialize the navigation bar
      NavigationBar.init('profile');
      
      const loadingEl = document.getElementById('loading');
      const notAuthenticatedEl = document.getElementById('not-authenticated');
      const profileDataEl = document.getElementById('profile-data');
      
      const profileNameEl = document.getElementById('profile-name');
      const profileUsernameEl = document.getElementById('profile-username');
      const profileJoinedEl = document.getElementById('profile-joined');
      const profileAvatarEl = document.getElementById('profile-avatar');
      
      const statContributionsEl = document.getElementById('stat-contributions');
      const statDrawersEl = document.getElementById('stat-drawers');
      const statConnectionsEl = document.getElementById('stat-connections');
      
      const authProvidersEl = document.getElementById('auth-providers');
      const editProfileBtn = document.getElementById('edit-profile-btn');
      const generateRecoveryKeyBtn = document.getElementById('generate-recovery-key-btn');
      const logoutBtn = document.getElementById('logout-btn');
      
      // Privacy settings elements
      const lurkerModeToggle = document.getElementById('lurker-mode-toggle');
      const lurkerRandomness = document.getElementById('lurker-randomness');
      const lurkerRandomnessValue = document.getElementById('lurker-randomness-value');
      const locationVisibilityToggle = document.getElementById('location-visibility-toggle');
      const defaultVisibilityRadios = document.getElementsByName('default-visibility');
      const savePrivacySettingsBtn = document.getElementById('save-privacy-settings');
      
      // Recovery key modal elements
      const recoveryKeyModal = document.getElementById('recovery-key-modal');
      const recoveryKeyDisplay = document.getElementById('recovery-key-display');
      const copyRecoveryKeyBtn = document.getElementById('copy-recovery-key-btn');
      const closeModalBtn = document.getElementById('close-modal-btn');
      
      // Update lurker randomness value display when slider changes
      lurkerRandomness.addEventListener('input', () => {
        lurkerRandomnessValue.textContent = `${lurkerRandomness.value}%`;
      });
      
      // Save privacy settings
      savePrivacySettingsBtn.addEventListener('click', async () => {
        try {
          // Get user ID from the URL or data attribute
          const userId = savePrivacySettingsBtn.getAttribute('data-user-id');
          if (!userId) {
            throw new Error('User ID not found');
          }
          
          // Get selected visibility option
          let defaultContentVisibility = 'public';
          for (const radio of defaultVisibilityRadios) {
            if (radio.checked) {
              defaultContentVisibility = radio.value;
              break;
            }
          }
          
          // Create preferences object
          const preferences = {
            lurkerModeEnabled: lurkerModeToggle.checked,
            lurkerModeRandomness: parseInt(lurkerRandomness.value),
            showLocationByDefault: locationVisibilityToggle.checked,
            defaultContentVisibility
          };
          
          console.log('Saving preferences:', preferences);
          
          // Save preferences
          const response = await fetch(`/api/users/${userId}/preferences`, {
            method: 'PATCH',
            credentials: 'include',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(preferences)
          });
          
          if (!response.ok) {
            throw new Error(`Failed to save preferences: ${response.status} ${response.statusText}`);
          }
          
          // Show success message
          alert('Preferences saved successfully');
        } catch (error) {
          console.error('Error saving preferences:', error);
          alert('Failed to save preferences. Please try again.');
        }
      });
      
      // Function to populate user preferences
      function populateUserPreferences(user) {
        // Set user ID as data attribute for save button
        savePrivacySettingsBtn.setAttribute('data-user-id', user.id);
        
        // Check if user has preferences
        if (user.preferences) {
          // Set lurker mode toggle
          lurkerModeToggle.checked = !!user.preferences.lurkerModeEnabled;
          
          // Set lurker randomness slider
          const randomness = user.preferences.lurkerModeRandomness || 50;
          lurkerRandomness.value = randomness;
          lurkerRandomnessValue.textContent = `${randomness}%`;
          
          // Set location visibility toggle
          locationVisibilityToggle.checked = !!user.preferences.showLocationByDefault;
          
          // Set default content visibility
          const visibility = user.preferences.defaultContentVisibility || 'public';
          for (const radio of defaultVisibilityRadios) {
            if (radio.value === visibility) {
              radio.checked = true;
              break;
            }
          }
        }
      }
      
      // Check for new registration notification
      const urlParams = new URLSearchParams(window.location.search);
      const isNewRegistration = urlParams.get('new') === 'true';
      
      if (isNewRegistration) {
        // Could add a welcome message here
        console.log('New registration detected');
      }
      
      // Function to check if user is authenticated and load profile data
      const loadProfileData = async () => {
        try {
          // Make request to get user profile using JWT auth
          console.log('Fetching user profile data from /api/auth/jwt/profile');
          const response = await fetch('/api/auth/jwt/profile', {
            credentials: 'include' // Important to send cookies!
          });
          
          console.log('Profile response:', response.status, response.statusText);
          
          if (!response.ok) {
            throw new Error(`Profile fetch failed: ${response.status} ${response.statusText}`);
          }
          
          const data = await response.json();
          console.log('Profile data:', data);
          
          if (!data || !data.username) {
            throw new Error('Invalid user data received');
          }
          
          // User is authenticated, populate profile data
          const user = data;
          
          // Set basic profile info
          profileNameEl.textContent = user.displayName || 'R3L User';
          profileUsernameEl.textContent = `@${user.username}`;
          
          // Format joined date
          const joinedDate = user.createdAt ? new Date(user.createdAt) : new Date();
          profileJoinedEl.textContent = `Joined on ${joinedDate.toLocaleDateString('en-US', { 
            year: 'numeric', 
            month: 'long', 
            day: 'numeric' 
          })}`;
          
          // Set avatar if available
          if (user.avatarUrl) {
            profileAvatarEl.src = user.avatarUrl;
            // Reset any custom styling
            profileAvatarEl.style = '';
            profileAvatarEl.innerHTML = '';
          } else if (user.avatar_key) {
            profileAvatarEl.src = `/api/files/${user.avatar_key}`;
            // Reset any custom styling
            profileAvatarEl.style = '';
            profileAvatarEl.innerHTML = '';
          } else {
            // Create an avatar with the first letter of the display name
            const initial = (user.displayName || user.username || '?').charAt(0).toUpperCase();
            
            // Use initial-based avatar
            profileAvatarEl.src = '';  // Clear the src
            profileAvatarEl.style.display = 'flex';
            profileAvatarEl.style.alignItems = 'center';
            profileAvatarEl.style.justifyContent = 'center';
            profileAvatarEl.style.fontSize = '3rem';
            profileAvatarEl.style.color = 'white';
            profileAvatarEl.style.backgroundColor = '#6d28d9';
            profileAvatarEl.innerHTML = initial;
          }
          
          // Show authentication providers
          authProvidersEl.innerHTML = '';
          
          // If using JWT auth, show that
          const jwtProvider = document.createElement('div');
          jwtProvider.className = 'auth-provider';
          jwtProvider.innerHTML = `
            <span class="material-icons">key</span>
            <span>Password</span>
          `;
          authProvidersEl.appendChild(jwtProvider);
          
          // Add recovery key information
          const recoveryKeyInfo = document.createElement('div');
          recoveryKeyInfo.className = 'auth-provider';
          recoveryKeyInfo.innerHTML = `
            <span class="material-icons">security</span>
            <span>Recovery Key</span>
          `;
          authProvidersEl.appendChild(recoveryKeyInfo);
          
          // Try to load user stats if available
          try {
            console.log(`Fetching stats for user ${user.id}`);
            const statsResponse = await fetch(`/api/users/${user.id}/stats`, {
              credentials: 'include'
            });
            
            console.log('Stats response:', statsResponse.status, statsResponse.statusText);
            
            if (statsResponse.ok) {
              const stats = await statsResponse.json();
              console.log('Stats data:', stats);
              
              statContributionsEl.textContent = stats.contributions || 0;
              statDrawersEl.textContent = stats.drawers || 0;
              statConnectionsEl.textContent = stats.connections || 0;
            } else {
              console.warn(`Stats fetch failed with status: ${statsResponse.status}`);
            }
          } catch (statsError) {
            console.warn('Could not load stats:', statsError);
            // Use defaults (already set in HTML)
          }
          
          // Load user's map points
          try {
            console.log(`Fetching map points for user ${user.id}`);
            
            // Set up avatar upload
            const avatarUploadOverlay = document.getElementById('avatar-upload-overlay');
            const avatarUploadInput = document.getElementById('avatar-upload');
            
            // Show overlay when hovering over avatar
            avatarUploadOverlay.classList.remove('hidden');
            
            // Handle avatar file selection
            avatarUploadInput.addEventListener('change', async (event) => {
              const file = event.target.files[0];
              if (!file) return;
              
              // Validate file type
              if (!file.type.startsWith('image/')) {
                alert('Please select an image file (PNG, JPG, GIF, etc.)');
                return;
              }
              
              // Show loading state
              profileAvatarEl.src = '/icons/loading-spinner.svg';
              
              try {
                // Create form data
                const formData = new FormData();
                formData.append('file', file);
                
                // Upload avatar
                const response = await fetch('/api/files/avatar', {
                  method: 'POST',
                  credentials: 'include',
                  body: formData
                });
                
                if (!response.ok) {
                  throw new Error(`Upload failed: ${response.status} ${response.statusText}`);
                }
                
                const result = await response.json();
                
                if (result.success && result.avatarUrl) {
                  // Update avatar with the new URL
                  profileAvatarEl.src = result.avatarUrl;
                  // Reset any custom styling
                  profileAvatarEl.style = '';
                  profileAvatarEl.innerHTML = '';
                } else {
                  throw new Error('Invalid response from server');
                }
              } catch (error) {
                console.error('Avatar upload error:', error);
                alert('Failed to upload avatar. Please try again.');
                // Reset to previous avatar or default
                if (user.avatarUrl) {
                  profileAvatarEl.src = user.avatarUrl;
                  profileAvatarEl.style = '';
                  profileAvatarEl.innerHTML = '';
                } else if (user.avatar_key) {
                  profileAvatarEl.src = `/api/files/${user.avatar_key}`;
                  profileAvatarEl.style = '';
                  profileAvatarEl.innerHTML = '';
                } else {
                  profileAvatarEl.src = '/icons/user-default.svg';
                  profileAvatarEl.style = '';
                  profileAvatarEl.innerHTML = '';
                }
              }
            });
            
            const mapPointsResponse = await fetch(`/api/globe/data-points?userId=${user.id}`, {
              credentials: 'include'
            });
            
            console.log('Map points response:', mapPointsResponse.status, mapPointsResponse.statusText);
            
            if (mapPointsResponse.ok) {
              const mapPoints = await mapPointsResponse.json();
              console.log('Map points data:', mapPoints);
              
              const mapPointsContainer = document.getElementById('user-map-points');
              const emptyState = document.querySelector('.empty-state');
              
              if (mapPoints && mapPoints.length > 0) {
                // Hide empty state if we have points
                emptyState.classList.add('hidden');
                
                // Populate the map points grid
                mapPointsContainer.innerHTML = '';
                
                mapPoints.forEach(point => {
                  const pointCard = document.createElement('div');
                  pointCard.className = 'map-point-card';
                  
                  // Format coordinates to 4 decimal places
                  const latitude = parseFloat(point.latitude).toFixed(4);
                  const longitude = parseFloat(point.longitude).toFixed(4);
                  
                  pointCard.innerHTML = `
                    <h4 class="map-point-title">${point.title}</h4>
                    <p class="map-point-coords">${latitude}, ${longitude}</p>
                    ${point.description ? `<p class="map-point-desc">${point.description}</p>` : ''}
                    <div class="map-point-actions">
                      <button class="view-on-map" data-id="${point.id}" aria-label="View on map">
                        <span class="material-icons">map</span>
                      </button>
                      ${point.contentId ? `
                      <button class="view-content" data-id="${point.contentId}" aria-label="View linked content">
                        <span class="material-icons">description</span>
                      </button>
                      ` : ''}
                      <button class="edit-point" data-id="${point.id}" aria-label="Edit point">
                        <span class="material-icons">edit</span>
                      </button>
                      <button class="delete-point" data-id="${point.id}" aria-label="Delete point">
                        <span class="material-icons">delete</span>
                      </button>
                    </div>
                  `;
                  
                  mapPointsContainer.appendChild(pointCard);
                });
                
                // Add event listeners for the action buttons
                mapPointsContainer.querySelectorAll('.view-on-map').forEach(button => {
                  button.addEventListener('click', () => {
                    const pointId = button.getAttribute('data-id');
                    window.location.href = `/map.html?point=${pointId}`;
                  });
                });
                
                mapPointsContainer.querySelectorAll('.view-content').forEach(button => {
                  button.addEventListener('click', () => {
                    const contentId = button.getAttribute('data-id');
                    window.location.href = `/drawer.html?content=${contentId}`;
                  });
                });
                
                mapPointsContainer.querySelectorAll('.edit-point').forEach(button => {
                  button.addEventListener('click', () => {
                    const pointId = button.getAttribute('data-id');
                    window.location.href = `/map.html?edit=${pointId}`;
                  });
                });
                
                mapPointsContainer.querySelectorAll('.delete-point').forEach(button => {
                  button.addEventListener('click', async () => {
                    const pointId = button.getAttribute('data-id');
                    
                    if (confirm('Are you sure you want to delete this map point?')) {
                      try {
                        const response = await fetch(`/api/globe/points/${pointId}`, {
                          method: 'DELETE',
                          credentials: 'include'
                        });
                        
                        if (response.ok) {
                          // Remove the point card from the DOM
                          button.closest('.map-point-card').remove();
                          
                          // If no more points, show empty state
                          if (mapPointsContainer.children.length === 0) {
                            emptyState.classList.remove('hidden');
                          }
                        } else {
                          alert('Failed to delete map point. Please try again.');
                        }
                      } catch (error) {
                        console.error('Error deleting map point:', error);
                        alert('Failed to delete map point. Please try again.');
                      }
                    }
                  });
                });
              } else {
                // If no points, ensure empty state is visible
                emptyState.classList.remove('hidden');
              }
            } else {
              console.warn(`Map points fetch failed with status: ${mapPointsResponse.status}`);
            }
          } catch (mapPointsError) {
            console.warn('Could not load map points:', mapPointsError);
          }
          
          // Populate user preferences
          populateUserPreferences(user);
          
          // Show profile data, hide loading
          loadingEl.classList.add('hidden');
          notAuthenticatedEl.classList.add('hidden');
          profileDataEl.classList.remove('hidden');
          
          // Set up edit profile button
          editProfileBtn.addEventListener('click', () => {
            // Redirect to edit profile page (to be implemented)
            window.location.href = '/edit-profile.html';
          });
          
          // Set up generate recovery key button
          generateRecoveryKeyBtn.addEventListener('click', async () => {
            try {
              // Show a confirmation dialog
              const confirmed = confirm(
                'WARNING: Generating a new recovery key will invalidate your old key. ' +
                'Make sure to save the new key securely. Continue?'
              );
              
              if (!confirmed) {
                return;
              }
              
              // Generate new recovery key
              const response = await fetch('/api/auth/jwt/generate-recovery-key', {
                method: 'POST',
                credentials: 'include'
              });
              
              if (!response.ok) {
                throw new Error(`Failed to generate recovery key: ${response.status} ${response.statusText}`);
              }
              
              const result = await response.json();
              
              if (!result.success || !result.recoveryKey) {
                throw new Error('Invalid response from server');
              }
              
              // Display the recovery key in the modal
              recoveryKeyDisplay.textContent = result.recoveryKey;
              recoveryKeyModal.classList.remove('hidden');
              
              // Set up copy button only once
              copyRecoveryKeyBtn.onclick = () => {
                navigator.clipboard.writeText(result.recoveryKey)
                  .then(() => {
                    const originalText = copyRecoveryKeyBtn.textContent;
                    copyRecoveryKeyBtn.textContent = 'Copied!';
                    setTimeout(() => {
                      copyRecoveryKeyBtn.textContent = originalText;
                    }, 2000);
                  })
                  .catch(err => {
                    console.error('Failed to copy: ', err);
                    alert('Failed to copy to clipboard. Please select and copy the key manually.');
                  });
              };
              
              // Set up close button only once
              closeModalBtn.onclick = () => {
                recoveryKeyModal.classList.add('hidden');
              };
              
            } catch (error) {
              console.error('Recovery key generation error:', error);
              alert('Failed to generate recovery key. Please try again.');
            }
          });
          
          // Set up logout button
          logoutBtn.addEventListener('click', async () => {
            try {
              await fetch('/api/auth/jwt/logout', {
                method: 'POST',
                credentials: 'include'
              });
              
              // Redirect to login page after logout
              window.location.href = '/auth/login.html?message=' + encodeURIComponent('You have been logged out successfully.');
            } catch (error) {
              console.error('Logout error:', error);
              alert('Failed to log out. Please try again.');
            }
          });
          
        } catch (error) {
          console.error('Profile loading error:', error);
          
          // Show not authenticated state
          loadingEl.classList.add('hidden');
          notAuthenticatedEl.classList.remove('hidden');
          profileDataEl.classList.add('hidden');
        }
      };
      
      // Load profile data on page load
      loadProfileData();
    });
  </script>
</body>
</html>
