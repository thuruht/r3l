<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Upload Content - R3L:F</title>
  <link rel="stylesheet" href="css/rel-f-global.css">
  <style>
    .upload-container {
      max-width: 800px;
      margin: 2rem auto;
      padding: 2rem;
      background: var(--bg-container);
      border-radius: var(--radius-lg);
    }
    .drop-zone {
      border: 2px dashed var(--accent-purple);
      border-radius: var(--radius-md);
      padding: 3rem;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s;
      background: var(--bg-subtle);
    }
    .drop-zone.dragover {
      background: var(--accent-purple-glow);
      border-color: var(--accent-green);
    }
    .drop-zone input[type="file"] {
      display: none;
    }
    .preview {
      margin: 1.5rem 0;
      padding: 1rem;
      background: var(--bg-subtle);
      border-radius: var(--radius-md);
    }
    .preview img, .preview video {
      max-width: 100%;
      border-radius: var(--radius-md);
    }
    .form-group {
      margin: 1.5rem 0;
    }
    .form-group label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 600;
    }
    .form-group input, .form-group textarea {
      width: 100%;
      padding: 0.75rem;
      border: 1px solid var(--border-primary);
      border-radius: var(--radius-md);
      background: var(--bg-input);
      color: var(--text-primary);
    }
    .progress-bar {
      width: 100%;
      height: 8px;
      background: var(--bg-subtle);
      border-radius: 4px;
      overflow: hidden;
      margin: 1rem 0;
    }
    .progress-fill {
      height: 100%;
      background: var(--accent-purple);
      transition: width 0.3s;
    }
  </style>
  <script src="/js/utils/debug-logger.js" defer></script>
</head>
<body>
  <header>
    <div class="container"></div>
  </header>
  <main class="container">
    <div class="upload-container">
      <h1>Upload Content</h1>
      <p class="text-muted">Share files with your connections. Content expires in 30 days unless archived.</p>
      
      <div class="drop-zone" id="dropZone">
        <span class="material-icons" style="font-size: 48px; color: var(--accent-purple);">cloud_upload</span>
        <p>Drag & drop files here or click to browse</p>
        <p class="text-muted">Max size: 10MB</p>
        <input type="file" id="fileInput" accept="image/*,video/*,audio/*,application/pdf">
      </div>
      
      <div id="preview" class="preview" style="display:none;"></div>
      
      <form id="uploadForm" style="display:none;">
        <div class="form-group">
          <label for="title">Title *</label>
          <input type="text" id="title" required maxlength="100">
        </div>
        <div class="form-group">
          <label for="description">Description</label>
          <textarea id="description" rows="4" maxlength="500"></textarea>
        </div>
        <div class="progress-bar" id="progressBar" style="display:none;">
          <div class="progress-fill" id="progressFill"></div>
        </div>
        <div style="display:flex;gap:1rem;margin-top:1.5rem;">
          <button type="submit" class="btn btn-primary">Upload</button>
          <button type="button" class="btn btn-secondary" id="cancelBtn">Cancel</button>
        </div>
      </form>
    </div>
  </main>
  <footer class="footer">
    <p class="footer-motto text-accent">"the rel is what you make it"</p>
  </footer>
  <script type="module">
    import { NavigationBar } from './js/components/navigation.js';
    NavigationBar.init('upload');

    const dropZone = document.getElementById('dropZone');
    const fileInput = document.getElementById('fileInput');
    const preview = document.getElementById('preview');
    const uploadForm = document.getElementById('uploadForm');
    const progressBar = document.getElementById('progressBar');
    const progressFill = document.getElementById('progressFill');
    let selectedFile = null;

    dropZone.addEventListener('click', () => fileInput.click());
    dropZone.addEventListener('dragover', (e) => {
      e.preventDefault();
      dropZone.classList.add('dragover');
    });
    dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));
    dropZone.addEventListener('drop', (e) => {
      e.preventDefault();
      dropZone.classList.remove('dragover');
      if (e.dataTransfer.files.length) handleFile(e.dataTransfer.files[0]);
    });
    fileInput.addEventListener('change', (e) => {
      if (e.target.files.length) handleFile(e.target.files[0]);
    });

    function handleFile(file) {
      if (file.size > 10 * 1024 * 1024) {
        alert('File too large. Max 10MB.');
        return;
      }
      selectedFile = file;
      document.getElementById('title').value = file.name.replace(/\.[^/.]+$/, '');
      
      preview.style.display = 'block';
      if (file.type.startsWith('image/')) {
        const img = document.createElement('img');
        img.src = URL.createObjectURL(file);
        preview.innerHTML = '';
        preview.appendChild(img);
      } else if (file.type.startsWith('video/')) {
        const video = document.createElement('video');
        video.src = URL.createObjectURL(file);
        video.controls = true;
        preview.innerHTML = '';
        preview.appendChild(video);
      } else {
        preview.innerHTML = `<p><strong>${file.name}</strong> (${(file.size / 1024).toFixed(2)} KB)</p>`;
      }
      uploadForm.style.display = 'block';
    }

    uploadForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      if (!selectedFile) return;

      try {
        progressBar.style.display = 'block';
        progressFill.style.width = '30%';

        const metadata = await window.r3l.apiPost('/api/content', {
          filename: selectedFile.name,
          contentType: selectedFile.type,
          fileSize: selectedFile.size,
          title: document.getElementById('title').value,
          description: document.getElementById('description').value
        });

        progressFill.style.width = '60%';

        await fetch(metadata.uploadUrl, {
          method: 'PUT',
          body: selectedFile,
          headers: { 'Content-Type': selectedFile.type }
        });

        progressFill.style.width = '100%';
        setTimeout(() => {
          window.location.href = `/content.html?id=${metadata.contentId}`;
        }, 500);
      } catch (error) {
        alert('Upload failed: ' + error.message);
        progressBar.style.display = 'none';
      }
    });

    document.getElementById('cancelBtn').addEventListener('click', () => {
      selectedFile = null;
      preview.style.display = 'none';
      uploadForm.style.display = 'none';
      fileInput.value = '';
    });
  </script>
</body>
</html>
